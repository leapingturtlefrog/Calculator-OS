<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Calculator OS</title>
    <link rel="icon" type="image/x-icon" href="/images/beancan.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@3.7/build/css/index.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #2a2a3a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-family: 'VT323', monospace;
        }
        
        .computer {
            position: relative;
            image-rendering: pixelated;
            transform-origin: top center;
            transition: transform 0.2s ease;
        }

        #computer_scale {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }
        
        .monitor {
            background: #c0c0c0;
            padding: 12px;
            border: 4px solid #808080;
            border-top-color: #fff;
            border-left-color: #fff;
        }
        
        .screen-bezel {
            background: #404040;
            padding: 4px;
            border: 4px solid #606060;
            border-top-color: #303030;
            border-left-color: #303030;
        }
        
        #screen_container {
            background: #000;
            border: 2px solid #000;
            width: 649px;
            height: 508px;
            max-width: 100%;
        }
        
        #screen_container canvas {
            display: block;
            image-rendering: pixelated;
        }
        
        .loading {
            color: #888;
            font-family: 'VT323', monospace;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .monitor-bottom {
            background: #c0c0c0;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 4px solid #808080;
            border-top: none;
            border-bottom-color: #fff;
            border-right-color: #fff;
        }
        
        .led {
            width: 8px;
            height: 8px;
            background: #004400;
            border: 1px solid #002200;
        }
        
        .led.on {
            background: #00ff00;
            box-shadow: 0 0 4px #00ff00;
        }
        
        .brand {
            font-size: 10px;
            color: #606060;
            letter-spacing: 2px;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 8px;
        }
        
        button {
            font-family: 'VT323', monospace;
            font-size: 16px;
            background: #c0c0c0;
            color: #000;
            border: 3px solid #808080;
            border-top-color: #fff;
            border-left-color: #fff;
            padding: 4px 16px;
            cursor: pointer;
        }
        
        button:hover {
            background: #d0d0d0;
        }
        
        button:active {
            border-top-color: #808080;
            border-left-color: #808080;
            border-bottom-color: #fff;
            border-right-color: #fff;
        }
        
        #status {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
        }

        #footer {
            margin-top: auto;
            padding-top: 10px;
            font-size: 14px;
            color: #888;
        }

        #footer a {
            color: #888;
            text-decoration: underline;
        }

        #footer a:hover {
            color: #aaa;
        }
        
        /* On-screen keyboard - retro style */
        #keyboard-container {
            margin-top: 15px;
            max-width: 400px;
            width: 100%;
        }
        
        .simple-keyboard {
            background: #c0c0c0;
            padding: 8px;
            border: 4px solid #808080;
            border-top-color: #fff;
            border-left-color: #fff;
            border-radius: 0;
        }
        
        .simple-keyboard .hg-button {
            font-family: 'VT323', monospace;
            font-size: 18px;
            background: #c0c0c0;
            color: #000;
            border: 3px solid #808080;
            border-top-color: #fff;
            border-left-color: #fff;
            border-radius: 0;
            height: 40px;
            cursor: pointer;
        }
        
        .simple-keyboard .hg-button:hover {
            background: #d0d0d0;
        }
        
        .simple-keyboard .hg-button:active,
        .simple-keyboard .hg-button.hg-activeButton {
            background: #a0a0a0;
            border-top-color: #808080;
            border-left-color: #808080;
            border-bottom-color: #fff;
            border-right-color: #fff;
        }
        
        .simple-keyboard .hg-row {
            gap: 4px;
            margin-bottom: 4px;
        }
        
        .simple-keyboard .hg-row:last-child {
            margin-bottom: 0;
        }
        
        /* Special button colors */
        .simple-keyboard .hg-button[data-skbtn="{enter}"] {
            background: #90c090;
            border-top-color: #c0f0c0;
            border-left-color: #c0f0c0;
        }
        
        .simple-keyboard .hg-button[data-skbtn="{enter}"]:hover {
            background: #a0d0a0;
        }
        
        .simple-keyboard .hg-button[data-skbtn="{bksp}"],
        .simple-keyboard .hg-button[data-skbtn="{esc}"] {
            background: #c09090;
            border-top-color: #f0c0c0;
            border-left-color: #f0c0c0;
        }
        
        .simple-keyboard .hg-button[data-skbtn="{bksp}"]:hover,
        .simple-keyboard .hg-button[data-skbtn="{esc}"]:hover {
            background: #d0a0a0;
        }

    </style>
</head>
<body>
    <div id="computer_scale">
        <div class="computer">
            <div class="monitor">
                <div class="screen-bezel">
                    <div id="screen_container">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="monitor-bottom">
                <div class="led" id="power-led"></div>
                <span class="brand">Calculator OS</span>
            </div>
        </div>
    </div>
    
    <div id="keyboard-container">
        <div class="simple-keyboard"></div>
    </div>
    
    <div class="controls">
        <button onclick="emulator.restart()">Restart</button>
        <button onclick="var c = document.querySelector('#screen_container canvas'); if(c) c.focus();">Focus</button>
    </div>
    <div id="status"></div>
    <div id="footer">A project by <a href="https://x.com/alexaridgides" target="_blank" rel="noopener">Alex Aridgides</a></div>

    <script src="/calculator-os/libv86.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-keyboard@3.7/build/index.min.js"></script>
    <script>
        "use strict";
        var emulator;
        var keyboard;
        var statusEl;
        var powerLed;
        var computerEl;
        var computerScaleEl;
        var computerBaseWidth;
        var computerBaseHeight;
        var controlsEl;
        var footerEl;
        
        // Simple scancode map for calculator keys
        var keyScancodes = {
            '0': [0x0B], '1': [0x02], '2': [0x03], '3': [0x04], '4': [0x05],
            '5': [0x06], '6': [0x07], '7': [0x08], '8': [0x09], '9': [0x0A],
            '.': [0x34],
            '+': [0x2A, 0x0D],  // Shift + =
            '-': [0x0C],
            '*': [0x2A, 0x09],  // Shift + 8
            '/': [0x35],
            '^': [0x2A, 0x07],  // Shift + 6
            '%': [0x2A, 0x06],  // Shift + 5
            '(': [0x2A, 0x0A],  // Shift + 9
            ')': [0x2A, 0x0B],  // Shift + 0
            '{enter}': [0x1C],
            '{bksp}': [0x0E],
            '{esc}': [0x01]
        };
        
        // Keys that need shift released after
        var shiftKeys = ['+', '*', '^', '%', '(', ')'];
        
        function sendKey(key) {
            if (!emulator) return;
            var codes = keyScancodes[key];
            if (!codes) return;
            
            // Send all key presses
            for (var i = 0; i < codes.length; i++) {
                emulator.keyboard_send_scancodes([codes[i]]);
            }
            
            // Send key releases in reverse order
            for (var i = codes.length - 1; i >= 0; i--) {
                emulator.keyboard_send_scancodes([codes[i] | 0x80]);
            }
        }
        
        function updateStatus(msg, isError) {
            console.log(msg);
            if (statusEl) {
                statusEl.textContent = msg;
                statusEl.style.color = isError ? '#f44' : '#888';
            }
        }

        function updateComputerScale() {
            if (!computerEl || !computerScaleEl || !computerBaseWidth || !computerBaseHeight) return;
            var availableWidth = window.innerWidth - 40;
            var controlsHeight = controlsEl ? controlsEl.getBoundingClientRect().height : 0;
            var statusHeight = statusEl ? statusEl.getBoundingClientRect().height : 0;
            var footerHeight = footerEl ? footerEl.getBoundingClientRect().height : 0;
            var keyboardHeight = document.getElementById('keyboard-container') ? document.getElementById('keyboard-container').getBoundingClientRect().height : 0;
            var availableHeight = window.innerHeight - 40 - 20 - 10 - 10 - controlsHeight - statusHeight - footerHeight - keyboardHeight - 20;
            var widthScale = availableWidth / computerBaseWidth;
            var heightScale = availableHeight / computerBaseHeight;
            var scale = 1;
            if (availableWidth < 750 || availableHeight < computerBaseHeight) {
                scale = Math.min(1, widthScale, heightScale);
            }
            computerEl.style.transform = "scale(" + scale + ")";
            computerScaleEl.style.height = (computerBaseHeight * scale) + "px";
        }
        
        function setupKeyboard() {
            var Keyboard = window.SimpleKeyboard.default;
            
            keyboard = new Keyboard('.simple-keyboard', {
                onKeyPress: function(button) {
                    sendKey(button);
                },
                layout: {
                    default: [
                        "7 8 9 / (",
                        "4 5 6 * )",
                        "1 2 3 - ^",
                        "0 . {enter} + %",
                        "{bksp} {esc}"
                    ]
                },
                display: {
                    '{enter}': '=',
                    '{bksp}': 'Del',
                    '{esc}': 'Clr'
                },
                theme: "hg-theme-default",
                disableButtonHold: true
            });
        }
        
        window.onload = function() {
            statusEl = document.getElementById("status");
            powerLed = document.getElementById("power-led");
            controlsEl = document.querySelector(".controls");
            footerEl = document.getElementById("footer");
            computerEl = document.querySelector(".computer");
            computerScaleEl = document.getElementById("computer_scale");
            
            // Setup keyboard first
            if (typeof window.SimpleKeyboard !== 'undefined') {
                setupKeyboard();
            }
            
            if (computerEl && computerScaleEl) {
                var rect = computerEl.getBoundingClientRect();
                computerBaseWidth = rect.width;
                computerBaseHeight = rect.height;
                updateComputerScale();
                window.addEventListener("resize", updateComputerScale);
            }
            
            if (typeof SharedArrayBuffer === 'undefined') {
                updateStatus('Error: SharedArrayBuffer not available. Use server.py', true);
                document.querySelector('.loading').textContent = 'SharedArrayBuffer required';
                return;
            }
            
            if (typeof V86 === 'undefined') {
                updateStatus('Error: v86 library failed to load', true);
                return;
            }
            
            updateStatus('Starting...');
            
            try {
                emulator = new V86({
                    wasm_path: "/calculator-os/v86.wasm",
                    memory_size: 16 * 1024 * 1024,
                    vga_memory_size: 2 * 1024 * 1024,
                    screen_container: document.getElementById("screen_container"),
                    bios: { url: "/calculator-os/bios/seabios.bin" },
                    vga_bios: { url: "/calculator-os/bios/vgabios.bin" },
                    fda: { url: "/calculator-os/os.img" },
                    autostart: true
                });
                
                emulator.add_listener("emulator-ready", function() {
                    updateStatus("Ready");
                });
                
                emulator.add_listener("emulator-started", function() {
                    updateStatus("Running");
                    if (powerLed) powerLed.classList.add('on');
                });
                
                emulator.add_listener("emulator-stopped", function() {
                    updateStatus("Stopped", true);
                    if (powerLed) powerLed.classList.remove('on');
                });
            } catch (e) {
                updateStatus('Error: ' + e.message, true);
                console.error(e);
            }
        };
    </script>
</body>
</html>
